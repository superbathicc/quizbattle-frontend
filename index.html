<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Quiz App</title>
    <style>
      /*
      #7289da 	(114,137,218)
      #ffffff 	(255,255,255)
      #99aab5 	(153,170,181)
      #2c2f33 	(44,47,51)
      #23272a 	(35,39,42)
    */

      @font-face {
        font-family: Lato;
        font-weight: normal;
        font-style: normal;
        src: url("/assets/fonts/Lato.woff");
      }

      @font-face {
        font-family: Lato;
        font-weight: bold;
        font-style: normal;
        src: url("/assets/fonts/Lato-Bold.woff");
      }

      @font-face {
        font-family: Lato;
        font-weight: normal;
        font-style: italic;
        src: url("/assets/fonts/Lato-Italic.woff");
      }

      @font-face {
        font-family: Lato;
        font-weight: bold;
        font-style: italic;
        src: url("/assets/fonts/Lato-BoldItalic.woff");
      }

      @font-face {
        font-family: Montserrat;
        font-weight: bold;
        src: url("/assets/fonts/Montserrat.otf");
      }

      @font-face {
        font-family: Ligature;
        font-weight: normal;
        font-style: normal;
        src: url("/assets/fonts/Ligature.woff");
      }

      body {
        margin: 0;
        font-family: Lato, sans-serif;
        font-variant-ligatures: none;
        color: #222;
      }

      header {
        height: 50px;
        background-color: #2c2f33;
        color: white;
      }

      div.header-content {
        margin: auto;
        max-width: 800px;
        height: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 1.5em;
        font-family: Montserrat;
        padding-right: 10px;
        padding-left: 10px;
      }

      div.nav-buttons {
      }

      h1 {
        font-family: Montserrat;
      }

      button.nav-button {
        display: inline-flex;
        justify-content: center;
        align-items: center;
        font-family: Ligature;
        width: 2.5em;
        height: 2.5em;
      }

      div.main-wrapper {
        margin: auto;
        max-width: 800px;
        padding: 10px;
        min-height: 75vh;
      }

      main#main {
        margin: 10px;
      }

      footer {
        background-color: #2c2f33;
        color: white;
      }

      .footer-content {
        margin: auto;
        max-width: 800px;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        flex-wrap: wrap;
        padding: 10px;
      }

      .footer-column {
        flex-basis: 25%;
        flex-grow: 1;
        flex-shrink: 1;
        padding: 10px;
      }

      h1.footer-heading {
        font-family: Montserrat;
        font-size: 1.2em;
        margin: 0;
      }

      button {
        border: none;
        cursor: pointer;
        font-family: Montserrat;
        transition: all 0.3s cubic-bezier(0.11, 1.45, 0.31, 1.64) 0s;
        padding: 10px;
        border-radius: 3px;
        user-select: none;
        -moz-user-select: none;
        color: white;
        background-color: #7289da;
        box-shadow: 0px 0px 5px 0px rgba(0, 0, 0, 0.3);
        outline: none;
      }

      button:hover {
        transform: scale(1.05);
        box-shadow: 0px 0px 5px 0px rgba(0, 0, 0, 0.3);
      }

      button:active {
        transform: scale(1);
        box-shadow: 0px 0px 5px 0px rgba(0, 0, 0, 0.3);
      }

      input[type="file"] {
        display: none;
      }

      label.file-input {
        border: none;
        cursor: pointer;
        font-family: Montserrat;
        transition: all 0.3s cubic-bezier(0.11, 1.45, 0.31, 1.64) 0s;
        padding: 10px;
        border-radius: 3px;
        user-select: none;
        -moz-user-select: none;
        color: white;
        background-color: #7289da;
        box-shadow: 0px 0px 5px 0px rgba(0, 0, 0, 0.3);
        outline: none;
        display: inline-block;
      }

      label.file-input:hover {
        transform: scale(1.05);
        box-shadow: 0px 0px 5px 0px rgba(0, 0, 0, 0.3);
      }

      label.file-input:active {
        transform: scale(1);
        box-shadow: 0px 0px 5px 0px rgba(0, 0, 0, 0.3);
      }

      button.main-button {
        display: block;
        margin-bottom: 1em;
        font-size: 1.5em;
        box-shadow: 0px 0px 5px 0px rgba(0, 0, 0, 0.3);
      }

      button.small-button {
        display: inline-block;
        margin-bottom: 1em;
        box-shadow: 0px 0px 10px 0px rgba(0, 0, 0, 0.5);
        font-size: 1em;
      }

      button.category {
        display: inline-block;
        margin-bottom: 1em;
        box-shadow: 0px 0px 10px 0px rgba(0, 0, 0, 0.5);
        background-color: #2c2f33;
        margin-right: 0.5em;
        font-size: 1em;
      }

      button.category-selected {
        background-color: #7289da;
      }

      div.question {
        border-radius: 3px;
        padding: 10px;
        box-shadow: 0px 0px 10px 0px rgba(0, 0, 0, 0.5);
        animation: popIn 0.5s ease 0s;
        margin-bottom: 1em;
      }

      div.results-screen {
        border-radius: 3px;
        padding: 10px;
        box-shadow: 0px 0px 10px 0px rgba(0, 0, 0, 0.5);
        animation: popIn 0.5s ease 0s;
        margin-bottom: 1em;
      }

      div.quiz-question {
      }

      div.quiz-text {
        border-radius: 3px;
        padding: 8px;
        box-shadow: 0px 0px 10px 0px rgba(0, 0, 0, 0.5);
        margin-bottom: 10px;
        font-size: 1.5em;
      }

      div.quiz-answer {
        border-radius: 3px;
        box-shadow: 0px 0px 10px 0px rgba(0, 0, 0, 0.5);
        margin-bottom: 1em;
        padding: 8px;
        position: relative;
        opacity: 0;
        animation: popIn 0.3s ease 0s forwards;
        font-size: 1.3em;
        display: flex;
        justify-content: flex-start;
        align-items: center;
      }

      div.quiz-answer-correct {
        border-radius: 3px;
        box-shadow: 0px 0px 10px 0px rgba(0, 0, 0, 0.5);
        margin-bottom: 1em;
        padding: 8px;
        position: relative;
        font-size: 1.3em;
        display: flex;
        justify-content: flex-start;
        align-items: center;
        background-color: #43b581;
      }

      div.winner-icon {
        float: right;
      }

      div.winner-icon img {
        width: 200px;
        height: auto;
      }

      div.player1-icon {
        display: inline-flex;
        height: 40px;
        width: 40px;
        position: absolute;
        right: 100%;
        justify-content: center;
        align-items: center;
        border-radius: 50%;
        margin-right: 10px;
        transform: scale(0);
        transition: transform 0.2s cubic-bezier(0.17, 0.67, 0.54, 1.57) 0s;
      }

      div.player2-icon {
        display: inline-flex;
        height: 40px;
        width: 40px;
        position: absolute;
        left: 100%;
        justify-content: center;
        align-items: center;
        border-radius: 50%;
        margin-left: 10px;
        padding: 1px;
        transform: scale(0);
        transition: transform 0.2s cubic-bezier(0.17, 0.67, 0.54, 1.57) 0s;
      }

      .player1-icon.icon-active {
        transform: scale(1);
        border: 3px solid #3ae9b5;
        background-position: 50%;
        background-size: cover;
        background-repeat: no-repeat;
      }

      .player2-icon.icon-active {
        transform: scale(1);
        border: 3px solid #d63070;
        background-position: 50%;
        background-size: cover;
        background-repeat: no-repeat;
      }

      @keyframes icon-active {
        0% {
          transform: scale(0);
        }

        100% {
          transform: scale(1);
        }
      }

      div.quiz-answer-number {
        display: inline-flex;
        justify-content: center;
        align-items: center;
        height: 40px;
        width: 40px;
        font-family: Montserrat;
        border-radius: 50%;
        color: white;
        background-color: #7289da;
        padding: 10px;
        font-size: 1.5em;
        margin-right: 10px;
        box-sizing: border-box;
      }

      div.quiz-header {
        font-family: Montserrat;
        font-size: 2em;
        margin-bottom: 10px;
        clear: both;
      }

      div#timer-bar {
        height: 10px;
        border-radius: 3px;
      }

      div#timer {
        font-family: Montserrat;
        font-size: 6em;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      div.timer-number {
        display: inline-block;
        animation: popIn 0.3s ease 0s forwards;
      }

      div.timer-number-finished {
        display: inline-block;
        color: #7289da;
        animation: popIn 0.3s ease 0s forwards;
      }

      @keyframes timer-bar {
        0% {
          width: 100%;
          background-color: rgb(114, 137, 218);
        }

        40% {
          background-color: rgb(114, 137, 218);
        }

        50% {
          background-color: rgb(185, 142, 0);
        }

        75% {
          background-color: rgb(185, 142, 0);
        }

        85% {
          background-color: rgb(185, 0, 0);
        }

        100% {
          width: 0%;
          background-color: rgb(185, 0, 0);
        }
      }

      div.question-header {
        font-weight: bold;
        padding-top: 10px;
        padding-bottom: 10px;
        clear: both;
      }

      @keyframes fadeIn {
        0% {
          opacity: 0;
        }

        100% {
          opacity: 1;
        }
      }

      @keyframes fadeOut {
        0% {
          opacity: 1;
        }

        100% {
          opacity: 0;
        }
      }

      @keyframes popIn {
        0% {
          transform: perspective(700px) translate3d(0, 0, 20px);
          opacity: 0;
        }

        100% {
          transform: perspective(0px) translate3d(0, 0, 0);
          opacity: 1;
        }
      }

      @keyframes slideInBottom {
        0% {
          transform: translateY(50px);
          opacity: 0;
        }

        100% {
          transform: translateY(0px);
          opacity: 1;
        }
      }

      @keyframes slideInRight {
        0% {
          transform: translateX(1100px);
        }

        100% {
          transform: translateX(0px);
        }
      }

      @keyframes slideInLeft {
        0% {
          transform: translateX(-1100px);
        }

        100% {
          transform: translateX(0px);
        }
      }

      @keyframes slideOutLeft {
        0% {
          transform: translateX(0px);
        }

        100% {
          transform: translateX(-1100px);
        }
      }

      @keyframes slideOutRight {
        0% {
          transform: translateX(0px);
        }

        100% {
          transform: translateX(1100px);
        }
      }

      div.loading-text {
        font-size: 3em;
        font-family: Montserrat;
      }

      div.loading-icons {
        display: flex;
        justify-content: center;
        align-items: center;
      }

      @keyframes pulse {
        0% {
          box-shadow: 0 0 0 0 rgba(114, 137, 218, 0.4);
        }
        70% {
          box-shadow: 0 0 0 50px rgba(114, 137, 218, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(114, 137, 218, 0);
        }
      }

      div.quiz-media {
        display: flex;
        justify-content: center;
        align-items: center;
        flex-flow: column;
        margin-bottom: 10px;
      }

      div.quiz-media img {
        max-height: 25vh;
        width: auto;
      }

      textarea[name="question"] {
        font-family: Lato, sans-serif;
        border-radius: 3px;
        resize: none;
        margin-bottom: 1em;
        border: none;
        padding: 5px;
        width: 450px;
        max-width: 100%;
        box-sizing: border-box;
        box-shadow: 0px 0px 5px 0px rgba(0, 0, 0, 0.3) inset;
      }

      input[type="text"] {
        font-family: Lato, sans-serif;
        border-radius: 3px;
        margin-bottom: 1em;
        resize: none;
        border: none;
        padding: 5px;
        box-shadow: 0px 0px 5px 0px rgba(0, 0, 0, 0.3) inset;
      }

      div#quiz {
        margin: 0px 50px;
      }

      div.question-text {
      }

      div.question-answer {
        animation: slideInBottom 0.3s cubic-bezier(0.64, -0.7, 0.27, 1.83) 0s;
        padding-bottom: 20px;
        height: 40px;
      }

      div.remove-button {
        float: right;
      }

      span.icon {
        font-family: Ligature;
      }

      div.template {
        display: none !important;
      }

      a.link {
        color: #7289da;
        text-decoration: none;
      }

      div.character-icons {
        display: flex;
        justify-content: flex-start;
        align-items: flex-start;
        flex-wrap: wrap;
      }

      button.character-icon {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100px;
        width: 100px;
        margin-right: 0.5em;
        margin-bottom: 0.5em;
        background-color: unset;
        opacity: 0;
      }

      button.character-icon img {
        height: auto;
        width: 100%;
      }

      button.character-icon.player1-character-selected {
        border: 3px solid #3ae9b5;
      }

      button.character-icon.player2-character-selected {
        border: 3px solid #d63070;
      }

      .spinner {
        margin: 100px auto;
        width: 100px;
        height: 100px;
        position: relative;
        text-align: center;

        -webkit-animation: sk-rotate 2s infinite linear;
        animation: sk-rotate 2s infinite linear;
      }

      .dot1,
      .dot2 {
        width: 60%;
        height: 60%;
        display: inline-block;
        position: absolute;
        top: 0;
        background-color: #7289da;
        border-radius: 100%;

        -webkit-animation: sk-bounce 2s infinite ease-in-out;
        animation: sk-bounce 2s infinite ease-in-out;
      }

      .dot2 {
        top: auto;
        bottom: 0;
        -webkit-animation-delay: -1s;
        animation-delay: -1s;
      }

      @keyframes sk-rotate {
        100% {
          transform: rotate(360deg);
          -webkit-transform: rotate(360deg);
        }
      }

      @keyframes sk-bounce {
        0%,
        100% {
          transform: scale(0);
          -webkit-transform: scale(0);
        }
        50% {
          transform: scale(1);
          -webkit-transform: scale(1);
        }
      }
    </style>
  </head>

  <script>
    // Start on DOM-Load
    document.addEventListener("DOMContentLoaded", function() {
      initialize();
    });

    // catch keypress
    window.addEventListener(
      "keyup",
      function(e) {
        keyPress(e);
      },
      false
    );

    // handle keypress
    function keyPress(e) {
      // Taste 1, Spieler 1
      if (e.keyCode == 49) {
        lockAnswer(1, 1);
      }
      // Taste 2, Spieler 1
      else if (e.keyCode == 50) {
        lockAnswer(1, 2);
      }
      // Taste 3, Spieler 1
      else if (e.keyCode == 51) {
        lockAnswer(1, 3);
      }
      // Taste 4, Spieler 1
      else if (e.keyCode == 52) {
        lockAnswer(1, 4);
      }
      // Taste 1, Spieler 2
      else if (e.keyCode == 65) {
        lockAnswer(2, 1);
      }
      // Taste 2, Spieler 2
      else if (e.keyCode == 66) {
        lockAnswer(2, 2);
      }
      // Taste 3, Spieler 2
      else if (e.keyCode == 67) {
        lockAnswer(2, 3);
      }
      // Taste 4, Spieler 2
      else if (e.keyCode == 68) {
        lockAnswer(2, 4);
      }
    }
    // Globals
    /*=========================================================*/
    let main = "";
    let currentQuestionNr = 0;
    let currentQuiz = [];
    let quizActive = false;
    let questionActive = false;
    let player1 = {};
    let player2 = {};
    let playerToSelect = 1;
    let categories = [];
    let selectedCategories = [];
    /*=========================================================*/

    function initialize() {
      main = document.getElementById("main");
      questionActive = false;
      quizActive = false;
      currentQuestionNr = 0;
      currentQuiz = [];
      player1 = {};
      player1.answers = [];
      player1.correctAnswers = 0;
      player1.character = "";
      player1.name = "Spieler 1";
      player2 = {};
      player2.answers = [];
      player2.correctAnswers = 0;
      player2.character = "";
      player2.name = "Spieler 2";
      selectedCategories = [];
      startApp();
    }

    // display functions
    function startApp() {
      showLoadingScreen("Quiz Battle wird gestartet...");
      getCategories(function() {
        main.innerHTML = getTemplate("start");
      });
    }

    function playQuiz() {
      main.innerHTML = getTemplate("play-quiz");
      let container = main.getElementsByClassName("categories")[0];
      if (categories.length == 0) {
        container.innerHTML =
          "<p>Es gibt noch keine Kategorien. Es müssen erst Kategorien mit Fragen erstellt werden.</p>";
      }
      for (let i = 0; categories.length > i; i++) {
        let button = document.createElement("button");
        button.className = "category";
        button.setAttribute(
          "onclick",
          `selectCategory(${i}), this.classList.toggle("category-selected")`
        );
        button.innerHTML = categories[i].name;
        container.appendChild(button);
      }
    }

    function createQuestion() {
      main.innerHTML = getTemplate("add-questions");
      let container = main.getElementsByClassName("questions")[0];
      if (!container) return;
      container.innerHTML = getTemplate("add-question");
    }

    function startQuiz() {
      quizActive = true;
      startTimer(
        5,
        function() {
          showQuestion(currentQuiz[currentQuestionNr]);
        },
        true
      );
    }

    function showLoadingScreen(text) {
      main.innerHTML = getTemplate("loading-screen");
      main.getElementsByClassName("loading-text")[0].innerHTML = text;
    }

    function showResults() {
      quizActive = false;
      questionActive = false;
      let html = "";
      html += '<div class="results-screen">';
      for (let i = 0; currentQuiz.length > i; i++) {
        let question = currentQuiz[i];
        let correctAnswers = [];
        for (let j = 0; question.answers.length > j; j++) {
          if (question.answers[j].correct === true) {
            correctAnswers[correctAnswers.length] = j;
          }
        }
        if (checkAnswers(player1.answers[i], correctAnswers)) {
          player1.correctAnswers++;
        }
        if (checkAnswers(player2.answers[i], correctAnswers)) {
          player2.correctAnswers++;
        }
      }
      if (player1.correctAnswers > player2.correctAnswers) {
        html += `<div class="quiz-header">Ergebnis: ${player1.name} gewinnt!
        <div class="winner-icon"><img src="${player1.character}"></div>
        </div>
        `;
      } else if (player2.correctAnswers > player1.correctAnswers) {
        html += `<div class="quiz-header">Ergebnis: ${player2.name} gewinnt!
        <div class="winner-icon"><img src="${player2.character}"></div>
        </div>
        `;
      } else {
        html += '<div class="quiz-header">Ergebnis: Unentschieden</div>';
      }
      html += `<div class="quiz-header">Erreichte Punkte</div>
      <p>${player1.name}: ${player1.correctAnswers}</p>
      <p>${player2.name}: ${player2.correctAnswers}</p>
      </div>
      `;

      html += '<div class="quiz-header">Ergebnisse im Detail</div>';

      for (let i = 0; currentQuiz.length > i; i++) {
        let question = currentQuiz[i];
        html += getQuestionResult(question, i);
      }

      main.innerHTML = html;
    }

    function getQuestionResult(question, nr) {
      let html = "";
      html += `<div class="quiz-header">Frage ${nr + 1}</div>
      <div class="quiz-question">
      <div class="quiz-text">${question.text}`;
      if (
        question.dataType !== null &&
        typeof question.dataType !== "undefined"
      ) {
        html += '<div class="quiz-media">';
        if (question.dataType.match("image")) {
          html += `<img src="data:${question.dataType};${question.dataEncoding},${question.data}">`;
        } else if (question.dataType.match("audio")) {
          html += `<br><audio src="data:${question.dataType};${question.dataEncoding},${question.data}" controls="controls"></audio>`;
        }
        html += "</div>";
      }
      html += "</div>";
      for (let j = 0; question.answers.length > j; j++) {
        if (question.answers[j].correct === true) {
          html += '<div class="quiz-answer-correct">';
        } else {
          html += '<div class="quiz-answer">';
        }
        html += `<div class="quiz-answer-number">${String.fromCharCode(
          j + 65
        )}</div>${question.answers[j].text}`;
        if (player1.answers[nr].includes(j)) {
          html += `<div class="player1-icon icon-active" style="background-image:url('${player1.character}')"></div>`;
        } else {
          html += '<div class="player1-icon"></div>';
        }
        if (player2.answers[nr].includes(j)) {
          html += `<div class="player2-icon icon-active" style="background-image:url('${player2.character}')"></div>`;
        } else {
          html += '<div class="player2-icon"></div>';
        }
        html += "</div>";
      }
      html += "</div>";
      return html;
    }

    function characterSelect() {
      main.innerHTML = getTemplate("character-select");
      let iconContainer = main.getElementsByClassName("character-icons")[0];
      for (let i = 1; i <= 42; i++) {
        let button = document.createElement("button");
        button.className = "character-icon";
        button.setAttribute("onclick", "selectCharacter(this)");
        button.innerHTML =
          '<img src="/assets/images/characters/_(' + i + ').png">';
        button.style.animation = "popIn 0.2s ease " + i * 0.05 + "s forwards";
        iconContainer.appendChild(button);
      }
    }

    function selectCharacter(src) {
      let charSource = src.firstChild.src;
      if (playerToSelect == 1) {
        let selected = document.getElementsByClassName(
          "player1-character-selected"
        );
        for (let i = selected.length; i--; ) {
          selected[i].classList.remove("player1-character-selected");
        }
        src.classList.add("player1-character-selected");
        player1.character = charSource;
        playerToSelect = 2;
      } else {
        let selected = document.getElementsByClassName(
          "player2-character-selected"
        );
        for (let i = selected.length; i--; ) {
          selected[i].classList.remove("player2-character-selected");
        }
        src.classList.add("player2-character-selected");
        player2.character = charSource;
        playerToSelect = 1;
      }
    }

    function addAnswer(src) {
      let question = src;
      if (!question) return;
      let answer = document.createElement("div");
      answer.className = "question-answer";
      let answerHTML = `
      <label>Antwort</label><br>
      <input placeholder="Antwort hier eingeben" type="text" name="answer">
      <input class="answer-checkbox" type="checkbox">
      <label>Richtig</label>
      `;
      let answers = main.querySelectorAll("div.question-answer");
      answer.innerHTML = answerHTML;
      question.insertBefore(
        answer,
        answers[answers.length - 1].nextElementSibling
      );
    }

    function selectCategory(i) {
      if (selectedCategories.includes(categories[i])) {
        selectedCategories.pop(categories[i]);
      } else {
        selectedCategories.push(categories[i]);
      }
    }

    function getRandomQuestion(categoryID, questionNr) {
      getData(
        `http://localhost:3003/question?category=${categoryID}&answers=4`
      ).then(function(response) {
        try {
          currentQuiz[questionNr] = JSON.parse(response);
        } catch (e) {
          alert(e);
        }
      });
    }

    function getRandomInt(min, max) {
      min = Math.ceil(min);
      max = Math.floor(max);
      return Math.floor(Math.random() * (max - min)) + min;
    }

    function createQuiz() {
      if (selectedCategories.length === 0) {
        alert("Es muss mindestens eine Kategorie ausgewählt sein.");
        return;
      }
      showLoadingScreen("Quiz wird erstellt...");
      let minQuestions = 10;
      let maxQuestions = 20;
      let questionAmount = getRandomInt(minQuestions, maxQuestions);

      let p = [];

      for (let i = 0; questionAmount > i; i++) {
        let randomCat = getRandomInt(0, selectedCategories.length - 1);
        let category = selectedCategories[randomCat];
        p.push(
          getData(
            `http://localhost:3003/question?category=${category._id}&answers=4`
          )
        );
      }

      Promise.all(p)
        .then(function(values) {
          for (let i = 0; values.length > i; i++) {
            try {
              let question = JSON.parse(values[i]);
              currentQuiz[i] = question;
            } catch (e) {
              alert(e);
            }
          }
          currentQuiz = currentQuiz.filter(
            (question, index, self) =>
              self.findIndex(q => q._id === question._id) === index
          );
          characterSelect();
        })
        .catch(function(e) {
          alert(e);
        });
    }

    function getCategories(callback) {
      getData("http://localhost:3003/categories")
        .then(function(response) {
          try {
            response = JSON.parse(response);
            for (let i = 0; response.length > i; i++) {
              categories[i] = response[i];
              categories[i].selected = false;
            }
          } catch (e) {
            alert("Fehler:" + e);
          }
        })
        .then(callback)
        .catch(function(e) {
          alert(e);
        });
    }

    function getData(url) {
      return new Promise(function(resolve, reject) {
        let xhttp = new XMLHttpRequest();
        xhttp.open("GET", url, true);
        xhttp.setRequestHeader("Content-type", "application/json");
        xhttp.onload = function() {
          resolve(xhttp.responseText);
        };
        xhttp.onerror = function() {
          reject(xhttp.statusText);
        };
        xhttp.send();
      });
    }

    function sendData(url, data, binary) {
      return new Promise(function(resolve, reject) {
        let xhttp = new XMLHttpRequest();
        xhttp.open("POST", url, true);
        if (!binary) xhttp.setRequestHeader("Content-type", "application/json");
        xhttp.onload = function() {
          resolve(xhttp.responseText);
        };
        xhttp.onerror = function() {
          reject(xhttp.statusText);
        };
        xhttp.send(data);
      });
    }

    function saveQuestion() {
      let questionContainer = document.getElementsByClassName("question")[0];

      if (questionContainer == null) {
        alert("Error: No questions found.");
        return;
      }

      let question = {};
      let answerArray = [];

      let foundAnswer = false;

      let questionText = questionContainer.querySelector(
        'textarea[name="question"]'
      ).value;
      if (questionText === "") {
        alert("Fehler: Die Frage kann nicht leer sein.");
      }
      let questionTime =
        parseInt(
          questionContainer.querySelector('input[name="question-time"').value
        ) || 10;
      let answers = questionContainer.getElementsByClassName("question-answer");
      let categoryName = questionContainer.querySelector(
        'input[name="category"]'
      ).value;
      let file = questionContainer.querySelector('input[name="data"').value;
      if (categoryName === "") {
        alert("Fehler: Keine Kategorie angegeben.");
        return;
      }

      for (let j = 0; answers.length > j; j++) {
        answerArray[j] = {};
        answerArray[j].text = answers[j].querySelector(
          'input[name="answer"]'
        ).value;
        if (answerArray[j].text === "") {
          alert(
            "Fehler: Eine Antwort kann nicht leer sein. Antwort:" + (j + 1)
          );
        }
        if (
          answers[j].querySelector('input[type="checkbox"]').checked == true
        ) {
          foundAnswer = true;
          answerArray[j].correct = true;
        } else {
          answerArray[j].correct = false;
        }
      }
      if (!foundAnswer) {
        alert("Your question needs at least one correct answer!");
        return;
      }
      question = {
        text: questionText,
        time: questionTime * 1000
      };

      // create a new question
      let questionResponse;
      sendData("http://localhost:3003/question", JSON.stringify(question))
        .then(function(result) {
          try {
            questionResponse = JSON.parse(result);
          } catch (e) {
            alert(e);
          }
        })
        .then(function() {
          return sendData(
            "http://localhost:3003/question/" +
              questionResponse._id +
              "/answer",
            JSON.stringify(answerArray)
          );
        })
        .then(function(response) {
          if (file !== "") {
            let form = document.getElementById("upload");
            let fileData = new FormData(form);
            return sendData(
              "http://localhost:3003/question/" +
                questionResponse._id +
                "/data",
              fileData,
              true
            );
          }
        })
        .then(function(response) {
          return setCategory(questionResponse._id, categoryName);
        })
        .then(function(response) {
          alert("Frage gespeichert.");
          getCategories(createQuestion());
        })
        .catch(function(e) {
          alert(e);
        });
    }

    function setCategory(questionID, categoryName) {
      let categoryID = "";

      for (let i = 0; categories.length > i; i++) {
        if (categories[i].name === categoryName) {
          categoryID = categories[i]._id;
        }
      }
      if (categoryID !== "") {
        return sendData(
          "http://localhost:3003/question/" + questionID + "/category",
          `{"id":"${categoryID}"}`
        );
      } else {
        return sendData(
          "http://localhost:3003/question/" + questionID + "/category",
          `{"name":"${categoryName}"}`
        );
      }
    }

    function shuffle(a) {
      let j, x, i;
      for (i = a.length - 1; i > 0; i--) {
        j = Math.floor(Math.random() * (i + 1));
        x = a[i];
        a[i] = a[j];
        a[j] = x;
      }
      return a;
    }

    function showQuestion(question) {
      if (typeof question.selected !== "undefined") {
        question.answers = question.selected;
      }
      question.answers = shuffle(question.answers);
      let playAudio = false;
      let audio;
      let html = `
      <div id="quiz">
      <div class="quiz-header">Frage ${currentQuestionNr + 1} </div>
      <div id="timer-bar" style="animation: timer-bar ${question.time /
        1000}s linear 0s"></div>
      <div class="quiz-question">
      <div class="quiz-text">${question.text}
      `;
      if (
        question.dataType !== null &&
        typeof question.dataType !== "undefined"
      ) {
        html += '<div class="quiz-media">';
        if (question.dataType.match("image")) {
          html += `<img src="data:${question.dataType};${question.dataEncoding},${question.data}">`;
        } else if (question.dataType.match("audio")) {
          html += `<img src="/assets/images/audio.png"><br>`;
          html += `<audio src="data:${question.dataType};${question.dataEncoding},${question.data}" controls="controls" autoplay="true">`;
        }
        html += "</div>";
      }
      html += "</div>";
      for (j = 0; question.answers.length > j; j++) {
        html += `
        <div class="quiz-answer">
        <div class="quiz-answer-number">${String.fromCharCode(j + 65)}</div>
        ${question.answers[j].text}
        <div class="player1-icon"></div>
        <div class="player2-icon"></div>
        </div>
        `;
      }
      html += `
      </div>
      </div>
      `;
      main.innerHTML = html;
      questionActive = true;

      if (currentQuestionNr++ < currentQuiz.length - 1) {
        startTimer(question.time / 1000, function() {
          saveAnswers();
          showQuestion(currentQuiz[currentQuestionNr]);
        });
      } else {
        startTimer(question.time / 1000, function() {
          saveAnswers();
          showResults();
        });
      }
    }

    function startTimer(length, callback, timerVisible) {
      if (!quizActive) {
        return;
      }
      if (timerVisible) {
        showTimer(length);
        length += 1;
      }
      window.setTimeout(function() {
        callback();
      }, length * 1000);
    }

    function showTimer(length) {
      let html = '<div id="timer">' + length + "</div>";
      main.innerHTML = html;
      let timerId = setTimeout(function tick() {
        let counter = parseInt(document.getElementById("timer").textContent);
        if (counter - 1 > 0) {
          document.getElementById(
            "timer"
          ).innerHTML = `<div class="timer-number">${counter - 1}</div>`;
        } else {
          document.getElementById("timer").innerHTML =
            '<div class="timer-number-finished">Start!</div>';
        }
        if (counter > 1) timerId = setTimeout(tick, 1000);
      }, 1000);
    }

    function checkAnswers(playerAnswers, correctAnswers) {
      if (playerAnswers.length !== correctAnswers.length) return false;
      for (let i = playerAnswers.length; i--; ) {
        if (playerAnswers[i] !== correctAnswers[i]) return false;
      }
      return true;
    }

    function saveAnswers() {
      let answers = document.getElementsByClassName("quiz-answer");
      let p1Answers = [];
      let p2Answers = [];
      let p1AnswerCount = 0;
      let p2AnswerCount = 0;
      for (let i = 0; answers.length > i; i++) {
        let p1 = answers[i].getElementsByClassName("player1-icon")[0];
        let p2 = answers[i].getElementsByClassName("player2-icon")[0];
        if (p1.classList.contains("icon-active")) {
          p1Answers[p1AnswerCount] = i;
          p1AnswerCount++;
        }
        if (p2.classList.contains("icon-active")) {
          p2Answers[p2AnswerCount] = i;
          p2AnswerCount++;
        }
      }
      player1.answers[currentQuestionNr - 1] = p1Answers;
      player2.answers[currentQuestionNr - 1] = p2Answers;
    }

    function lockAnswer(playerNr, answerNr) {
      if (!questionActive) return;
      let answer = document.getElementsByClassName("quiz-answer")[answerNr - 1];
      let icon = answer.getElementsByClassName(
        "player" + playerNr + "-icon"
      )[0];
      icon.classList.toggle("icon-active");
      if (playerNr == 1) {
        icon.style.backgroundImage = `url("${player1.character}")`;
      } else {
        icon.style.backgroundImage = `url("${player2.character}")`;
      }
    }

    // Get template to display
    function getTemplate(id) {
      let template = document.getElementById(id);
      if (!template) {
        template = document.getElementById("error");
      }
      template = template.innerHTML;
      return template.trim();
    }
  </script>

  <body>
    <header>
      <div class="header-content">
        Quiz Battle
        <div class="nav-buttons">
          <button class="nav-button" onclick="window.location.reload()">
            home
          </button>
        </div>
      </div>
    </header>
    <div class="main-wrapper">
      <main id="main"></main>
    </div>
    <footer>
      <div class="footer-content">
        <div class="footer-column">
          <img style="max-width: 90%;" src="/assets/images/superbasic.png" />
        </div>
        <div class="footer-column">
          <h1 class="footer-heading">Impressum</h1>
          <p>
            Superbasic GmbH<br />
            Andreas-Gordon-Schule<br />
            Weidengasse 8<br />
            99089 Erfurt
          </p>
        </div>
        <div class="footer-column">
          <h1 class="footer-heading">Credits</h1>
          <p>
            Character Icons made by
            <a
              class="link"
              href="https://www.freepik.com/"
              target="blank"
              rel="noopener"
              >Frepik</a
            >
            from
            <a
              class="link"
              href="http://www.flaticon.com"
              target="blank"
              rel="noopener"
              >www.flaticon.com</a
            >
          </p>
        </div>
      </div>
    </footer>

    <div class="template" id="start">
      <button class="main-button" onclick="playQuiz()">
        <span class="icon">play </span>Quiz spielen
      </button>
      <button class="main-button" onclick="createQuestion()">
        <span class="icon">add </span>Frage hinzufügen
      </button>
      <h1>Was ist Quiz Battle?</h1>
      <p>Mit Quiz Battle könnt ihr</p>
      <ul style="padding-left:1em;">
        <li>gegeneinander (1vs1) antreten. Möge der clevere gewinnen!</li>
        <li>euer Wissen spielerisch erweitern. Spaß für alle!</li>
        <li>einen eigenen Fragenkatalog erstellen. Komplett individuell!</li>
        <li>
          einen von über 40 Charakteren auswählen. Für jeden ist etwas dabei!
        </li>
      </ul>
      <h1>Wie funktioniert's?</h1>
      <p>
        Zuerst erstellt ihr einen Fragenkatalog. Jede Frage wird einer Kategorie
        zugeordnet.
      </p>
      <p>
        Anschließend startet ihr das Quiz. Wählt eure gewünschten Kategorien
        aus, und die App erstellt euch automatisch ein zufälliges Quiz mit
        Fragen aus den gewählten Kategorien.
      </p>
      <p>
        Jeder Spieler wählt einen Charakter und einen Namen aus, und das Quiz
        beginnt.
      </p>
      <p>
        Schnappt euch die Controller und beantwortet die Fragen, ohne Pause,
        pure Action.
      </p>
      <p>
        Am Ende werden euch eure Ergebnisse präsentiert.
      </p>
    </div>

    <div class="template" id="add-questions">
      <div class="questions"></div>
      <button class="small-button" onclick="saveQuestion()">
        Frage speichern
      </button>
    </div>

    <div class="template" id="play-quiz">
      <div class="quiz-header">Kategorien wählen</div>
      <div class="categories"></div>
      <button class="small-button" onclick="createQuiz()">Quiz starten</button>
    </div>
    <div class="template" id="loading-screen">
      <div class="loading-text"></div>
      <div class="loading-icons">
        <div class="spinner">
          <div class="dot1"></div>
          <div class="dot2"></div>
        </div>
      </div>
    </div>

    <div class="template" id="character-select">
      <div class="quiz-header">Charakterauswahl</div>
      <div>
        <label>Name Spieler 1</label><br /><input
          type="text"
          onchange="player1.name = this.value;"
        /><br />
        <label>Name Spieler 2</label><br /><input
          type="text"
          onchange="player2.name = this.value;"
        />
      </div>
      <div class="character-icons"></div>
      <button class="main-button" onclick="startQuiz()">Start</button>
    </div>

    <div class="template" id="add-question">
      <div class="question">
        <div class="question-header">Frage</div>
        <div class="question-text">
          <textarea
            placeholder="Fragentext"
            default
            rows="5"
            name="question"
          ></textarea>
        </div>
        <label>Verfügbare Zeit (in Sekunden)</label><br />
        <input type="text" name="question-time" value="" /><br />
        <div class="question-answer">
          <label>Antwort</label><br />
          <input placeholder="Antwort" type="text" value="" name="answer" />
          <input class="answer-checkbox" type="checkbox" />
          <label>Richtig</label>
        </div>
        <div class="question-answer">
          <label>Antwort</label><br />
          <input placeholder="Antwort" type="text" value="" name="answer" />
          <input class="answer-checkbox" type="checkbox" />
          <label>Richtig</label>
        </div>
        <div class="question-answer">
          <label>Antwort</label><br />
          <input placeholder="Antwort" type="text" value="" name="answer" />
          <input class="answer-checkbox" type="checkbox" />
          <label>Richtig</label>
        </div>
        <div class="question-answer">
          <label>Antwort</label><br />
          <input placeholder="Antwort" type="text" value="" name="answer" />
          <input class="answer-checkbox" type="checkbox" />
          <label>Richtig</label>
        </div>
        <div>
          <button
            class="small-button"
            onclick="addAnswer(this.closest('div.question'))"
          >
            Antwort hinzufügen
          </button>
        </div>
        <div>
          <label>Kategorie</label><br />
          <input placeholder="Kategorie" type="text" value="" name="category" />
        </div>
        <div>
          <form
            action=""
            method="POST"
            enctype="multipart/form-data"
            id="upload"
          >
            <label>Opional: Datei (Bild oder Audio) hinzufügen</label><br />
            <label class="file-input"
              >Datei auswählen
              <input
                accept="image/*,audio/*"
                type="file"
                onchange="main.getElementsByClassName('file-name')[0].innerHTML = this.value"
                name="data"
              />
            </label>
            <span class="file-name"></span>
          </form>
        </div>
      </div>
    </div>

    <div class="template" id="error">
      <div class="quiz-header">Fehler</div>
      <p>Interner Fehler.</p>
    </div>
  </body>
</html>
